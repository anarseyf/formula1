---
output: rmarkdown::github_document
---

```{r packages, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

packages <- c(
  "tidyr", "knitr", "ggplot2", "tibble"
)
install.packages(setdiff(packages, rownames(installed.packages())),
  repos = "http://cran.us.r-project.org"
)

library(ggplot2)
library(dplyr)
library(tidyr)
library(knitr)
library(tibble)
```

```{r theme}

theme_set(theme_light())

theme_update(
  axis.title = element_blank(),
  legend.position = "none"
)
```

```{r dataset}

races <- read.csv("./data/races.csv") %>% mutate(date = as.Date(date))
standings <- read.csv("./data/driver_standings.csv")
drivers <- read.csv("./data/drivers.csv")
circuits <- read.csv("./data/circuits.csv")
results <- read.csv("./data/results.csv")
lap_times_1060 <- read.csv("./data/lap_times_1060.csv")
```

# Formula 1 World Champions

```{r, eval=FALSE}
races %>%
  ggplot(aes(x = date, y = round)) +
  geom_point()
```

```{r, eval=FALSE}
lap_times_1060 %>%
  mutate(driverId = factor(driverId)) %>%
  ggplot(aes(x = lap, y = position, group = driverId, color = driverId)) +
  geom_point(aes(color = driverId)) +
  geom_step(aes(color = driverId))
```

```{r}

last_races <- races %>%
  filter(year < 2021) %>% # 2021 season is incomplete as of today
  group_by(year) %>%
  mutate(last_race = max(round)) %>%
  filter(round == last_race) %>%
  select(year, raceId, round) %>%
  arrange(year)

constructor_mapping <- standings %>%
  filter(raceId %in% last_races$raceId) %>%
  inner_join(results, by = c("raceId", "driverId")) %>%
  select(raceId, driverId, constructorId)


standings_endofseason_leaders <- standings %>%
  filter(raceId %in% last_races$raceId) %>%
  inner_join(races, by = "raceId") %>%
  select(year, raceId, driverId, points, position) %>%
  group_by(year) %>%
  filter(position == 1 | position == 2) %>%
  arrange(year, position) %>%
  left_join(constructor_mapping, by = c("raceId", "driverId")) %>%
  select(year, driverId, constructorId, points, position)

dupl <- duplicated(standings_endofseason_leaders)
standings_endofseason_leaders[!dupl, ]


# arrange(raceId, position)

standings_endofseason_leaders

rivals <- standings_endofseason_leaders %>%
  # inner_join(drivers, by = "driverId") %>%
  inner_join(last_races, by = "raceId") %>%
  mutate(num_rounds = round) %>%
  select(year, driverId, constructorId, num_rounds, position) %>%
  mutate(position = ifelse(position == 1, "championId", "runnerupId"))

rivals

spread(position, driverId) %>%
  arrange(desc(year))

rivals

results_wins <- results %>%
  filter(position == 1) %>%
  inner_join(races, by = "raceId") %>%
  group_by(year) %>%
  select(year, raceId, round, driverId, position) %>%
  inner_join(rivals, by = "year", suffix = c("", "_CHA")) %>%
  arrange(desc(year), desc(round)) %>%
  select(year, raceId, round, num_rounds, driverId, championId, runnerupId) %>%
  mutate(
    won_by =
      ifelse(driverId == championId, "champion",
        ifelse(driverId == runnerupId, "runnerup", "other")
      )
  ) %>%
  filter(year > 2010)

results_wins

win_count <- results_wins %>%
  filter(won_by == "champion") %>%
  group_by(year) %>%
  tally() %>%
  arrange(desc(year))

win_count

champion_names <- rivals %>%
  inner_join(drivers, by = c("championId" = "driverId")) %>%
  select(year, firstname, lastname) %>%
  head(10)

champion_names

runnerup_names <- rivals %>%
  inner_join(drivers, by = c("runnerupId" = "driverId")) %>%
  select(year, firstname, lastname) %>%
  head(10)

runnerup_names
```

```{r, fig.height=12}

min_year <- min(champion_names$year)
max_year <- max(champion_names$year)
champion_color <- "#cf1616"
runnerup_color <- "#0e2461"

ggplot(data = champion_names, aes(
  x = -12, y = year
)) +
  geom_text(
    hjust = "left",
    mapping = aes(label = paste(firstname, lastname)),
    fontface = "bold"
    # color = champion_color
  ) +
  geom_text(
    data = runnerup_names,
    mapping = aes(x = 25, y = year, label = paste(firstname, lastname)),
    hjust = "left",
    # color = runnerup_color
  ) +
  scale_y_reverse(breaks = seq(min_year, max_year)) +
  geom_point(
    data = results_wins,
    aes(x = round, y = year, fill = won_by, shape = won_by),
    size = 3
  ) +
  scale_shape_manual(values = c("champion" = 19, "runnerup" = 13, "other" = 21)) +
  scale_fill_manual(
    values =
      c("champion" = champion_color, "runnerup" = runnerup_color, "other" = "white")
  )
# geom_text(
#   data = win_count,
#   aes(y = year, x = 24, label = n), hjust = "right",
# )
```

```{r}
races %>%
  group_by(circuitId) %>%
  tally() %>%
  inner_join(circuits, by = "circuitId") %>%
  select(n, circuitRef, location, country) %>%
  arrange(desc(n))
```

## Credit

Inspired by https://github.com/gkaramanis/tidytuesday/tree/master/2020/2020-week15.