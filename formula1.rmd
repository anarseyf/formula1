---
output: rmarkdown::github_document
---

```{r packages, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

packages <- c(
  "tidyr", "knitr", "ggplot2", "tibble", "ggtheme"
)
install.packages(setdiff(packages, rownames(installed.packages())),
  repos = "http://cran.us.r-project.org"
)

library(ggplot2)
library(dplyr)
library(tidyr)
library(knitr)
library(tibble)
```

```{r theme}

theme_set(theme_minimal())

theme_update(
  axis.title = element_blank(),
  legend.position = "none"
)
```

```{r dataset}

races <- read.csv("./data/races.csv") %>% mutate(date = as.Date(date))
standings <- read.csv("./data/driver_standings.csv")
drivers <- read.csv("./data/drivers.csv")
constructors <- read.csv("./data/constructors.csv")
circuits <- read.csv("./data/circuits.csv")
results <- read.csv("./data/results.csv")
qualifying <- read.csv("./data/qualifying.csv")
lap_times_1060 <- read.csv("./data/lap_times_1060.csv")
```

# Formula 1 World Champions

```{r, eval=FALSE}
races %>%
  ggplot(aes(x = date, y = round)) +
  geom_point()
```

```{r, eval=FALSE}
lap_times_1060 %>%
  mutate(driverId = factor(driverId)) %>%
  ggplot(aes(x = lap, y = position, group = driverId, color = driverId)) +
  geom_point(aes(color = driverId)) +
  geom_step(aes(color = driverId))
```

```{r}

filter_by_year <- function(data) {
  # data %>% filter(year > 2000)
  data %>% filter(year > 1949)
}

last_races <- races %>%
  filter(year < 2021) %>% # 2021 season is incomplete as of today
  group_by(year) %>%
  mutate(last_race = max(round)) %>%
  filter(round == last_race) %>%
  select(year, raceId, round) %>%
  arrange(year)

constructor_mapping <- results %>%
  select(raceId, driverId, constructorId) %>%
  inner_join(races %>% select(raceId, year, round), by = "raceId") %>%
  group_by(year, driverId) %>%
  filter(round == max(round)) %>%
  select(year, driverId, constructorId) %>%
  arrange(desc(year))

standings_endofseason_leaders <- standings %>%
  filter(raceId %in% last_races$raceId) %>%
  inner_join(races %>% select(raceId, year), by = "raceId") %>%
  filter(position == 1 | position == 2) %>%
  select(year, driverId, points, position, wins) %>%
  inner_join(constructor_mapping, by = c("year", "driverId")) %>%
  arrange(year, position)

dupl <- duplicated(standings_endofseason_leaders)
championship_rivals <- standings_endofseason_leaders[!dupl, ] %>%
  select(year, driverId, constructorId, position, points, wins)

champions <- championship_rivals %>%
  filter(position == 1) %>%
  mutate(championId = driverId) %>%
  select(year, championId) %>%
  arrange(desc(year))

runners_up <- championship_rivals %>%
  filter(position == 2) %>%
  mutate(runnerupId = driverId) %>%
  select(year, runnerupId) %>%
  arrange(desc(year))


pole_sitters <- results %>%
  filter(grid == 1) %>%
  mutate(polesitterId = driverId) %>%
  select(raceId, polesitterId) %>%
  arrange(raceId)

dupl_index <- pole_sitters %>%
  select(raceId) %>%
  duplicated()

pole_sitters <- pole_sitters[!dupl_index, ]

race_by_race <- results %>%
  filter(position == 1) %>%
  select(raceId, driverId) %>%
  inner_join(races %>% select(year, round, raceId), by = "raceId") %>%
  select(year, round, raceId, driverId) %>%
  inner_join(champions, by = "year") %>%
  inner_join(runners_up, by = "year") %>%
  arrange(desc(year), desc(round)) %>%
  mutate(
    won_by =
      ifelse(driverId == championId, "champion",
        ifelse(driverId == runnerupId, "runnerup", "other")
      )
  ) %>%
  left_join(pole_sitters) %>%
  filter_by_year()


# results %>%
#   filter(grid == 1) %>%
#   select(raceId) %>%
#   inner_join(races %>% select(raceId, year)) %>%
#   group_by(year) %>%
#   tally() %>%
#   right_join(last_races) %>%
#   mutate(missing = round - n) %>%
#   select(year, round, missing) %>%
#   arrange(year) %>%
#   print(n=Inf) # '51-57 and '64 have duplicates? TODO


champion_names <- champions %>%
  inner_join(drivers, by = c("championId" = "driverId")) %>%
  select(year, championId, firstname, lastname) %>%
  filter_by_year()

champion_counts <- champion_names %>%
  group_by(championId) %>%
  summarise(count = n())

champion_table <- champion_names %>%
  inner_join(champion_counts) %>%
  arrange(year) %>%
  filter_by_year()

dupl_index <- champion_table %>%
  select(championId) %>%
  duplicated()

champion_table <- champion_table[!dupl_index, ]

runnerup_names <- runners_up %>%
  inner_join(drivers, by = c("runnerupId" = "driverId")) %>%
  select(year, firstname, lastname) %>%
  filter_by_year()

champion_constructors <- champions %>%
  inner_join(constructor_mapping, by = c("year", "championId" = "driverId")) %>%
  inner_join(constructors %>% select(constructorId, name), by = "constructorId") %>%
  filter_by_year()

runnerup_constructors <- runners_up %>%
  inner_join(constructor_mapping, by = c("year", "runnerupId" = "driverId")) %>%
  inner_join(constructors %>% select(constructorId, name), by = "constructorId") %>%
  filter_by_year()

stats_table <- race_by_race %>%
  group_by(year) %>%
  summarize(
    champion_wins = sum(driverId == championId),
    champion_poles = sum(polesitterId == championId),
    runnerup_wins = sum(driverId == runnerupId),
    runnerup_poles = sum(polesitterId == runnerupId)
  )
```

```{r main, fig.width=12, fig.height=24}

min_year <- min(champion_names$year)
max_year <- max(champion_names$year)
champion_color <- "#cf1616"
runnerup_color <- "#0e2461"

offset_left <- -40
offset_middle <- -10
offset_right <- 30

ggplot() +
  geom_text(
    data = champion_names,
    hjust = "left",
    mapping = aes(x = offset_left, y = year, label = paste(firstname, lastname)),
    fontface = "bold"
    # color = champion_color
  ) +
  geom_text(
    data = runnerup_names,
    mapping = aes(x = offset_right, y = year, label = paste(firstname, lastname)),
    hjust = "left",
    # color = runnerup_color
  ) +
  geom_text(
    data = champion_constructors,
    mapping = aes(x = offset_left, y = year + 0.4, label = name),
    hjust = "left",
    fontface = "italic"
    # color = runnerup_color
  ) +
  geom_text(
    data = runnerup_constructors,
    mapping = aes(x = offset_right, y = year + 0.4, label = name),
    hjust = "left",
    fontface = "italic"
    # color = runnerup_color
  ) +
  geom_point(
    data = race_by_race,
    aes(x = round + offset_middle, y = year, fill = won_by, shape = won_by),
    size = 3
  ) +
  scale_shape_manual(
    values =
      c("champion" = 19, "runnerup" = 13, "other" = 21)
  ) +
  scale_fill_manual(
    values =
      c("champion" = champion_color, "runnerup" = runnerup_color, "other" = "white")
  ) +
  scale_y_reverse(breaks = seq(min_year, max_year), expand = c(0, 0)) +
  # scale_x_continuous(expand = c(0, 10)) +
  geom_point(
    data = subset(race_by_race, polesitterId == championId),
    aes(x = round + offset_middle, y = year),
    fill = NA,
    shape = 21,
    size = 5,
    stroke = 1
  ) +
  geom_label(
    data = champion_table,
    aes(x = offset_left - 5, y = year, label = count),
    size = 5
  ) +
  geom_text(
    data = stats_table,
    mapping = aes(x = offset_middle - 10, y = year, label = champion_wins),
    hjust = "left"
  ) +
  geom_text(
    data = stats_table,
    mapping = aes(
      x = offset_middle - 5, y = year,
      label = sprintf("(%d)", champion_poles)
    ),
    hjust = "left"
  ) +
  geom_text(
    data = stats_table,
    mapping = aes(x = offset_right - 15, y = year, label = runnerup_wins),
    hjust = "left"
  ) +
  geom_text(
    data = stats_table,
    mapping = aes(
      x = offset_right - 10, y = year,
      label = sprintf("(%d)", runnerup_poles)
    ),
    hjust = "left"
  )
```

```{r, eval=FALSE}
races %>%
  group_by(circuitId) %>%
  tally() %>%
  inner_join(circuits, by = "circuitId") %>%
  select(n, circuitRef, location, country) %>%
  arrange(desc(n))
```

## Data notes

### Multiple P1 entries for some races

These races have more than one entry in `results.csv` for pole-sitter (`grid = 1`):

```
   raceId polesitterId
1     717          374
2     717          373
3     780          479
4     785          608
5     791          608
6     792          642
7     792          427
8     814          633
9     815          697
10    824          475
11    828          786
```

The reasons are kind of wild. See for example:

* Race ID 792: https://en.wikipedia.org/wiki/1955_Argentine_Grand_Prix
* Race ID 717: https://en.wikipedia.org/wiki/1964_United_States_Grand_Prix

### Pole position based on starting grid

The dataset does not contain qualy times for over half of all the 1000+ races. I am using starting grid position P1 instead.

## Credit

Inspired by https://github.com/gkaramanis/tidytuesday/tree/master/2020/2020-week15.