---
output: rmarkdown::github_document
---

```{r packages, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

packages <- c(
  "tidyr", "knitr", "ggplot2", "tibble"
)
install.packages(setdiff(packages, rownames(installed.packages())),
  repos = "http://cran.us.r-project.org"
)

library(ggplot2)
library(dplyr)
library(tidyr)
library(knitr)
library(tibble)
```

```{r theme}

theme_set(theme_light())

theme_update(
  axis.title = element_blank(),
  legend.position = "none"
)
```

```{r dataset}

races <- read.csv("./data/races.csv") %>% mutate(date = as.Date(date))
standings <- read.csv("./data/driver_standings.csv")
drivers <- read.csv("./data/drivers.csv")
constructors <- read.csv("./data/constructors.csv")
circuits <- read.csv("./data/circuits.csv")
results <- read.csv("./data/results.csv")
lap_times_1060 <- read.csv("./data/lap_times_1060.csv")
```

# Formula 1 World Champions

```{r, eval=FALSE}
races %>%
  ggplot(aes(x = date, y = round)) +
  geom_point()
```

```{r, eval=FALSE}
lap_times_1060 %>%
  mutate(driverId = factor(driverId)) %>%
  ggplot(aes(x = lap, y = position, group = driverId, color = driverId)) +
  geom_point(aes(color = driverId)) +
  geom_step(aes(color = driverId))
```

```{r}

last_races <- races %>%
  filter(year < 2021) %>% # 2021 season is incomplete as of today
  group_by(year) %>%
  mutate(last_race = max(round)) %>%
  filter(round == last_race) %>%
  select(year, raceId, round) %>%
  arrange(year)

constructor_mapping <- results %>%
  select(raceId, driverId, constructorId) %>%
  inner_join(races %>% select(raceId, year, round), by = "raceId") %>%
  group_by(year, driverId) %>%
  filter(round == max(round)) %>%
  select(year, driverId, constructorId) %>%
  arrange(desc(year))

standings_endofseason_leaders <- standings %>%
  filter(raceId %in% last_races$raceId) %>%
  inner_join(races %>% select(raceId, year), by = "raceId") %>%
  filter(position == 1 | position == 2) %>%
  select(year, driverId, points, position, wins) %>%
  inner_join(constructor_mapping, by = c("year", "driverId")) %>%
  arrange(year, position)

dupl <- duplicated(standings_endofseason_leaders)
championship_rivals <- standings_endofseason_leaders[!dupl, ] %>%
  select(year, driverId, constructorId, position, points, wins)

champions <- championship_rivals %>%
  filter(position == 1) %>%
  mutate(championId = driverId) %>%
  select(year, championId) %>%
  arrange(desc(year))

runners_up <- championship_rivals %>%
  filter(position == 2) %>%
  mutate(runnerupId = driverId) %>%
  select(year, runnerupId) %>%
  arrange(desc(year))

results_wins <- results %>%
  filter(position == 1) %>%
  select(raceId, driverId) %>%
  inner_join(races %>% select(year, round, raceId), by = "raceId") %>%
  select(year, round, raceId, driverId) %>%
  inner_join(champions, by = "year") %>%
  inner_join(runners_up, by = "year") %>%
  arrange(desc(year), desc(round)) %>%
  mutate(
    won_by =
      ifelse(driverId == championId, "champion",
        ifelse(driverId == runnerupId, "runnerup", "other")
      )
  ) %>%
  filter(year > 2000)

champion_names <- champions %>%
  inner_join(drivers, by = c("championId" = "driverId")) %>%
  select(year, firstname, lastname) %>%
  filter(year > 2000)

runnerup_names <- runners_up %>%
  inner_join(drivers, by = c("runnerupId" = "driverId")) %>%
  select(year, firstname, lastname) %>%
  filter(year > 2000)

champion_constructors <- champions %>%
  inner_join(constructor_mapping, by = c("year", "championId" = "driverId")) %>%
  inner_join(constructors %>% select(constructorId, name), by = "constructorId") %>%
  filter(year > 2000)

runnerup_constructors <- runners_up %>%
  inner_join(constructor_mapping, by = c("year", "runnerupId" = "driverId")) %>%
  inner_join(constructors %>% select(constructorId, name), by = "constructorId") %>%
  filter(year > 2000)
```

```{r, fig.height=12}

min_year <- min(champion_names$year)
max_year <- max(champion_names$year)
champion_color <- "#cf1616"
runnerup_color <- "#0e2461"

ggplot(data = champion_names, aes(
  x = -12, y = year
)) +
  geom_text(
    hjust = "left",
    mapping = aes(label = paste(firstname, lastname)),
    fontface = "bold"
    # color = champion_color
  ) +
  geom_text(
    data = runnerup_names,
    mapping = aes(x = 25, y = year, label = paste(firstname, lastname)),
    hjust = "left",
    # color = runnerup_color
  ) +
  geom_text(
    data = champion_constructors,
    mapping = aes(x = -12, y = year + 0.25, label = name),
    hjust = "left",
    fontface = "italic"
    # color = runnerup_color
  ) +
  geom_text(
    data = runnerup_constructors,
    mapping = aes(x = 25, y = year + 0.25, label = name),
    hjust = "left",
    fontface = "italic"
    # color = runnerup_color
  ) +
  scale_y_reverse(breaks = seq(min_year, max_year)) +
  geom_point(
    data = results_wins,
    aes(x = round, y = year, fill = won_by, shape = won_by),
    size = 3
  ) +
  scale_shape_manual(values = c("champion" = 19, "runnerup" = 13, "other" = 21)) +
  scale_fill_manual(
    values =
      c("champion" = champion_color, "runnerup" = runnerup_color, "other" = "white")
  )
```

```{r, eval=FALSE}
races %>%
  group_by(circuitId) %>%
  tally() %>%
  inner_join(circuits, by = "circuitId") %>%
  select(n, circuitRef, location, country) %>%
  arrange(desc(n))
```

## Credit

Inspired by https://github.com/gkaramanis/tidytuesday/tree/master/2020/2020-week15.